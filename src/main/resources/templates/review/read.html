<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시글 읽기</title>
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/reviewRead.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/css/lightbox.min.css">
   	<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/js/lightbox.min.js"></script>
    
    <script src="/js/index.js"></script>
    
    <script th:inline="javascript">
    
    lightbox.option({
  	  resizeDuration: 200,
  	  wrapAround: true,
  	  disableScrolling: false,
  	  fitImagesInViewport: false,
  	  maxWidth:700,
  	  maxHeight:700,
  	   	 
  	})
    
      function writeReply() {
        let review_id = [[${review.review_id}]];
        let content = $("#reply").val();
        // 리플 내용이 없으면 등록하지 않는다.
        if (content === "") {
          alert("리플 내용을 입력하세요");
          $("#reply").focus();
          return;
        }
        $.ajax({
          url: "/reply/" + review_id,
          type: "post",
          data: {
            "content": content
          },
          success: function (data, success, xhr) {
            console.log(data);
            getReplies();
          },	
          error: function (xhr, status, error) {
            console.log(status);
          }
        });
      }

      function getReplies() {
        let review_id = [[${review.review_id}]];
        $.ajax({
          url: "/reply/" + review_id,
          success: function (data, success, xhr) {
            console.log(data);
            showReplies(data);
          },
          error: function (xhr, status, error) {
            console.log(status);
          }
        });
      }

      function showReplies(data) {
        $("#replies").html("");
        let str = "";
        str += "<table>";
        str += "  <tr>";
        str += "      <th>No.</th>";
        str += "      <th>내용.</th>";
        str += "      <th>작성자.</th>";
        str += "      <th>작성일</th>";
        str += "  </tr>";
        if (data.length > 0) {
          $(data).each(function(idx, obj) {
            let created_time = new Date(obj.created_time);
            let time = created_time.getFullYear() + "."
                    + (created_time.getMonth() + 1) + "."
                    + created_time.getDate() + ". "
                    + created_time.getHours() + ":"
                    + created_time.getMinutes();

            str += "<tr>";
            str += "  <td class='center'>" + (idx + 1) + "</td>";
            if (obj.writer == true) {
              str += "  <td><input type='text' id='reply_" + obj.reply_id + "' value='" + obj.content + "'>";
              str += "<input type='button' value='수정' onclick='updateReply(" + obj.reply_id + ")'>";
              str += "<input type='button' value='삭제' onclick='removeReply(" + obj.reply_id + ")'>";
            } else {
              str += "  <td>" + obj.content;
            }
            str += "  </td>";
            str += "  <td class='center'>" + obj.member_id + "</td>";
            str += "  <td class='center'>" + time + "</td>";
            str += "</tr>";
          });
        } else {
          str += "<tr>"
          str += "<td class='center' colspan='4'>등록된 리플이 없습니다.</td>"
          str += "<tr>"
        }
        str += "</table>";
        $("#replies").append(str);
      }

      function updateReply(reply_id) {
        let check = confirm("리플을 수정 하시겠습니까?");
        if (check) {
          let review_id = [[${review.review_id}]];
          let content = $("#reply_" + reply_id).val();
          $.ajax({
            url: "/reply/" + review_id + "/" + reply_id,
            type: "put",
            data: {
              "content": content
            },
            success: function (data) {
              console.log(data);
              getReplies();
            },
            error: function (xhr, status, error) {
              console.log(status);
            }
          });
        }
      }

      function removeReply(reply_id) {
        let check = confirm("리플을 삭제 하시겠습니까?");
        if (check) {
          let review_id = [[${review.review_id}]];
          $.ajax({
            url: "/reply/" + review_id + "/" + reply_id,
            type: "delete",
            success: function (data) {
              getReplies();
            },
            error: function (xhr, status, error) {
              console.log(status);
            }
          });
        }
      }

      $(function () {
        // 페이지가 로딩되면 getReplies() 함수를 자동으로 호출한다.
        getReplies();
        // 리플을 작성하고 엔터키를 입력하면 리플을 등록한다.
        $("#reply").keydown(function(event){
          if (event.originalEvent.code === "Enter") {
            writeReply();
          }
        });
      });
      
      //좋아요 버튼

      $(document).ready(function () {
          $(".content").click(function () {
              $(".content").toggleClass("heart-active")
              $(".like").toggleClass("heart-active")
              $(".heart").toggleClass("heart-active")
              $(".numb").toggleClass("heart-active")
          });
      });


      
    </script>
</head>
<body>
<div th:replace ="fragments/header :: header">
  	</div>
<div id="container">

 <div class="read-container">
        <table>
            <h2>Read Review</h2>

            <table th:object="${review}" class="read-table">

				<tr>
                    <th>리뷰 장소</th>
                    <td th:text="*{review_place}" colspan="3"></td>
                </tr>

                <tr>
                    <th>제목</th>
                    <td th:text="*{title}" colspan="3"></td>
                </tr>

                <tr>
                    <th>작성자</th>
                    <td th:text="*{member_id}" colspan="3"></td>
                </tr>
                <tr>
                <tr>
                    <th>작성일</th>
                    <td th:text="${#temporals.format(review.created_time, 'yyyy-MM-dd HH:mm')}"></td>
                    <th>조회수</th>
                    <td th:text="*{hit}"></td>
                </tr>
                <tr>
                    <th>사진</th>
                    <td colspan="3">
                        <img src="01.jpeg" alt="사진1">
                        <img src="02.jpg" alt="사진2">
                    </td>
                </tr>

                <tr>
                    <th>내용</th>
                    <td th:utext="*{contents}" colspan="3">
                       
                    </td>
                </tr>


            </table>


            <div class="heart-btn">
                <div class="content">
                    <span class="heart"></span>
                    <span class="like">Like</span>
                    <span class="numb"></span>
                </div>
            </div>
            
            <div class="reply-div">
                <table class="reply-table">
                    <tr>
                        <th>No.</th>
                        <th>작성자</th>
                        <th>내용</th>
                        <th>작성일</th>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>실크로드</td>
                        <td>재밋겠네용</td>
                        <td>2023.5.30</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>메롱</td>
                        <td>으</td>
                        <td>2023.5.30</td>
                    </tr>
                </table>

                <div class="reply-container">
                    <input class="reply-input" id="reply" name="reply" type="text" placeholder=" 댓글을 작성해주세요." value="">
                    <button type="submit" class="reply-btn" onclick="writeReply()">작성</button>
                </div>
                <p></p>
                <div class="read-btns">
                    <input class="read-btn" type="button" onclick="location.href='/review/list'" value="목록으로">
                </div>

            </div>

        </table>

    </div>

    
</div>
</body>
</html>